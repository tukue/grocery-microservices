version: 0.2

phases:
  install:
    runtime-versions:
      terraform: 1.0
  pre_build:
    commands:
      - export TF_VAR_image_tag=${IMAGE_TAG:-${CODEBUILD_RESOLVED_SOURCE_VERSION:0:7}}
      - echo "Using image tag for Terraform: ${TF_VAR_image_tag}"
      - cd terraform
      - |
        terraform init \
          -backend-config="bucket=${TF_BACKEND_BUCKET}" \
          -backend-config="key=${TF_BACKEND_KEY}" \
          -backend-config="region=${TF_BACKEND_REGION}" \
          -backend-config="dynamodb_table=${TF_BACKEND_DYNAMODB_TABLE}" \
          -backend-config="encrypt=true"
  build:
    commands:
      - terraform plan -out=tfplan
  post_build:
    commands:
      - echo "Terraform Plan complete. Waiting for approval to apply."

artifacts:
  files:
    - terraform/tfplan
